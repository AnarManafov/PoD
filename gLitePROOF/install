#! /bin/bash

############ Vars ######################
VERSION=2.0.4

INSTALL_PATH=/home/anar/svn-dgrid/dgrid/gLitePROOF/trunk/gLitePROOF

GAW_PKG=glite-api-wrapper-3.0.0.1699
GAW_LINK=http://www-linux.gsi.de/~manafov/D-Grid/Release/Stable/GAW
GAW_OPTIONS="--prefix=$INSTALL_PATH --enable-tests=no"

PROOFAgent_PKG=proofagent-1.0.3.1467
PROOFAgent_LINK=http://www-linux.gsi.de/~manafov/D-Grid/Release/Stable/gLitePROOF
PROOFAgent_OPTIONS="--prefix=$INSTALL_PATH"

PAConsole_PKG=PAConsole-1.0.3
PAConsole_LINK=http://www-linux.gsi.de/~manafov/D-Grid/Release/Stable/gLitePROOF
PAConsole_OPTIONS=



APP_PATH=$INSTALL_PATH/app
TMP_PATH=$APP_PATH/tmp
########################################






############ Funstions ##################
CreateCFG()
{
echo "Creating default cfg files..."
# generating gLitePROOF_ENV.sh
   cp -f template/gLitePROOF_ENV.sh.template ./gLitePROOF_ENV.sh
   eval sed -i 's%_G_WRK_DIR%$INSTALL_PATH%g' ./gLitePROOF_ENV.sh
# Using eval to force variable substitution
# changing _G_MASTER_HOSTNAME to a host name (FQDN) of the xrootd master:
    MASTER_HOST=`hostname -f`
# generating xpd.cf
    cp -f template/xpd.cf.template etc/xpd.cf
    eval sed -i 's%_G_MASTER_HOSTNAME%$MASTER_HOST%g' etc/xpd.cf
# generating proofagent.cfg.xml
    cp -f template/proofagent.cfg.xml.template etc/proofagent.cfg.xml
    eval sed -i 's%_G_MASTER_HOSTNAME%$MASTER_HOST%g' etc/proofagent.cfg.xml

    return 0
}

_GetModule() #parameters: $1 - package name; $2 - URL
{
   wget --tries=2 --directory-prefix=$TMP_PATH $2/$1.tar.gz  || return 1
   tar -C $APP_PATH -xzf $TMP_PATH/$1.tar.gz || return 1
}

InstallGAW()
{
    _GetModule $GAW_PKG $GAW_LINK

    pushd $APP_PATH/$GAW_PKG
    ./configure $GAW_OPTIONS || return 1
    gmake || return 1
    gmake install || return 1
    popd
       
    echo
    echo "---> GAW has been installed."
    return 0
}

InstallPROOFAgent()
{
    _GetModule $PROOFAgent_PKG $PROOFAgent_LINK

    pushd $APP_PATH/$PROOFAgent_PKG
    ./configure $PROOFAgent_OPTIONS || return 1
    gmake || return 1
    gmake install || return 1
    popd
       
    echo
    echo "---> PROOFAgent has been installed."
    return 0
}

InstallPAConsole()
{
    _GetModule $PAConsole_PKG $PAConsole_LINK

    pushd  $APP_PATH/$PAConsole_PKG
    ./build.sh || return 1
    gmake || return 1
    cp Build/PAConsole $INSTALL_PATH/bin/
    popd
    
    echo
    echo "---> PAConsole has been installed."
    return 0
}

InstallApps()
{
    mkdir -p $TMP_PATH

    InstallGAW || return 1
    InstallPROOFAgent || return 1
    InstallPAConsole || return 1

    return 0
}






####### Main
echo "--------------------"
echo "gLitePROOF v."$VERSION
echo "--------------------"
echo

InstallApps

RET_VAL=$?
echo
echo
if [ "X$RET_VAL" = "X0" ]; then
  echo "---> All gLitePROOF modules have been successfully installed."

else
  echo "---> ERROR: Failed to install gLitePROOF modules."
fi

echo "---> deleting temporary files..."
rm -rf $TMP_PATH

CreateCFG || (echo "Error: can't create cfg files."; exit 1)

echo "Installation successfully done."
exit 0
