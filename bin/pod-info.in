#!/usr/bin/env bash
#/************************************************************************/
#/**
# * @file pod-info.in
# * @brief a script, which manages PoD's information
# * @author Anar Manafov A.Manafov@gsi.de
# *//*
#
#        created by:        Anar Manafov
#                           2010-01-26
#
#        Copyright (c) 2010 GSI, Scientific Computing devision. All rights reserved.
#*************************************************************************/
#
# Usage: pod-info [-s] [-n] [-l] [-v] [-c] [-h] 
# -s : print PoD server status
# -n : print a  number of currently available PROOF workers
# -l : list all available PROOF workers
# -v : print version information
# -c : print a PROOF connection string, which can be used in TProof::Open

#######
eval PROOF_CFG=$(pod-user-defaults -c $POD_LOCATION/etc/PoD.cfg --key server.proof_cfg_path)
POD_VERSION=@POD_VERSION@
#######

#=============================================================================
# ***** USAGE *****
#=============================================================================
usage() {
    cat <<EOF
PoD information utility.
   Copyright (C) 2010 GSI, Scientific Computing group.

Usage: pod-info [OPTION]
    -s    Show PoD server status.
    -n    Report a number of currently available PROOF workers.
    -l    List all available PROOF workers.
    -v    Print version information.
    -c    Show a PROOF connection string, which can be used in TProof::Open.
    -h    Show summary of options.

Report bugs to http://pod.gsi.de
EOF
}
#=============================================================================
# ***** CHECK PROOF_CFG
#=============================================================================
check_proof_cfg() {
  if [ ! -r $PROOF_CFG ]; then
    echo "Error: can't open: $PROOF_CFG" >&2
    exit 1
  fi
}
#=============================================================================
# ***** NUMBER OF PROOF WORKERS
#=============================================================================
number_workers() {
  check_proof_cfg
  echo "$(cat $PROOF_CFG | grep -v "#" | grep worker | wc -l)"
}
#=============================================================================
# ***** LIST OF PROOF WORKERS
#=============================================================================
list_workers() {
  check_proof_cfg
  echo "$(cat $PROOF_CFG | grep -v "#" | grep worker )"
}
#=============================================================================
# ***** PROOF CONNECTION STRING
#=============================================================================
proof_connection_string() {
echo "$($POD_LOCATION/bin/pod-server status | grep 'connection string' | egrep -o '([a-zA-Z.0-9]*:[0-9]*$)')"
}
#=============================================================================
# ***** MAIN  *****
#=============================================================================
# checking the number of parameters
if [ $# -ne 1 ]; then
    usage
    exit 1
fi

while getopts ":snlvch" opt; do
  case $opt in
  s)
    $POD_LOCATION/bin/pod-server status
    ;;
  n)
    number_workers
    ;;
  l)
    list_workers
    ;;
  v)
    echo "PoD v$POD_VERSION"
    ;;
  c)
    proof_connection_string
    ;;
  h) 
    usage
    exit 0
    ;;
  \?)
    echo "Invalid option: -$OPTARG" >&2
    exit 1
    ;;
  esac
done



exit 0
