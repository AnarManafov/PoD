#!/usr/bin/env bash
#/************************************************************************/
#/**
# * @file pod-prep-worker
# * @brief a script, which prepares a worker package - all elements of PoD which need to be uploaded to a worker
# * @author Anar Manafov A.Manafov@gsi.de
# *//*
#
#        created by:        Anar Manafov
#                           2010-01-28
#
#        Copyright (c) 2010 GSI, Scientific Computing devision. All rights reserved.
#*************************************************************************/
#
# Usage: pod-prep-worker 
#
# Comment:
#    The worker package is saved to PoD server working directory.
#
eval WRK_DIR=$(pod-user-defaults --key server.work_dir)
ARC_NAME="$WRK_DIR/wrk/pod-worker.tar"
ARC_NAME_GZ=$ARC_NAME".gz"
USER_SCRIPT=$(pod-user-defaults --userenvscript)
WN_BINS="$POD_LOCATION/bin/wn_bins/*"
SERVER_INFO_FILE="$WRK_DIR/etc/server_info.cfg"
XPD_CFG="$WRK_DIR/etc/xpd.cf"
#=============================================================================
# ***** MAIN  *****
#=============================================================================

echo "preparing PoD worker package..."
   
# first delete a previous archive if available
if [ -f $ARC_NAME ]; then
   rm -rf $ARC_NAME
fi
if [ -f $ARC_NAME_GZ ]; then
   rm -rf $ARC_NAME_GZ
fi

POD_CFG=$(pod-user-defaults -p)
if [ -z "$POD_CFG" ]; then
   echo "error: can't find PoD user defaults"
   exit 1
fi

# check that all needed components are available
COMPONENTS_ETC=( "$XPD_CFG" 
             "$POD_CFG"
             "$POD_LOCATION/etc/version"
             "$SERVER_INFO_FILE" )

COMPONENTS=(  "${COMPONENTS_ETC[@]}" )

# create an empty archive first
tar cvf $ARC_NAME --files-from=/dev/null 

# add all default components
for i in "${COMPONENTS[@]}"
do
   if [ -f $i ]; then
      tar --append --file=$ARC_NAME -C $(dirname $i) $(basename $i)
      RET_VAL=$?
      if [ "X$RET_VAL" = "X0" ]; then
	 continue
      else
	 echo "failed. Exit code: $RET_VAL" >&2
	 exit 1
      fi
   else
      echo "Error: missing component: $i" >&2
      rm -rf $ARC_NAME
      exit 1
   fi
done

# add user's script if present
if [ -r "$USER_SCRIPT" ]; then
   echo "Adding a user defined environment script to worker package..."
   tar --append --file=$ARC_NAME -C $(dirname $USER_SCRIPT) $(basename $USER_SCRIPT)
fi

# add all pre-compiled bins
echo "Adding pre-compiled bins to worker package..."
for i in ${WN_BINS[@]} 
do
   tar --append --file=$ARC_NAME -C $(dirname $i) $(basename $i)
   RET_VAL=$?
   if [ "X$RET_VAL" != "X0" ]; then
      echo "failed. Exit code: $RET_VAL" >&2
      exit 1
   fi
done

# compress the archive
gzip -9 $ARC_NAME
echo "finished successfully: "$ARC_NAME_GZ

exit 0

