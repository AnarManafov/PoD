#!/usr/bin/env bash
#/************************************************************************/
#/**
# * @file pod-ssh-submit-worker
# * @brief 
# * @author Anar Manafov A.Manafov@gsi.de
# *//*
#
#        created by:        Anar Manafov
#                           2010-06-10
#
#        Copyright (c) 2010 GSI, Scientific Computing group. All rights reserved.
#*************************************************************************/
#
# Usage
# $1 ssh host (login@host.fqdn)
# $2 remote working dir
# $3 ssh params

#TODO: ssh params must be passed to the "-o" option of scp
# except -P

TOOL_NAME="pod-ssh-submit-worker"
WRK_P="$POD_LOCATION/etc/pod-worker.tar.gz"
WRK_S_R=PoDWorker.sh
WRK_S_L="$POD_LOCATION/etc/PoDWorker.sh"

SSH_CMD="ssh -n -f -q $1 $3 PasswordAuthentication=no"
SCP_CMD="scp $3"

# check that the worker package is ready
if [ ! -r $WRK_PKG ]; then
echo "$TOOL_NAME error: can't read a PoD worker package \"$WRK_PKG\""
exit 1
fi

# create remote dir
$SSH_CMD "mkdir -p $2"
if [ $? -ne 0 ]; then
    echo "$TOOL_NAME error: can't create directory \"$2\" on the host \"$1\""
    exit 1
fi

# send a worker package and worker's script
$SCP_CMD $WRK_P $WRK_S_L $1:$2/
if [ $? -ne 0 ]; then
    echo "$TOOL_NAME error: failed to send worker's package"
    exit 1
fi

# execute the worker script
$SSH_CMD "nohup bash -c \"cd $2 && ./$WRK_S_R &> ssh_worker.log \" &> ssh_worker.log  < /dev/null &"
if [ $? -ne 0 ]; then
    echo "$TOOL_NAME error: faild to start PoD worker"
    exit 1
fi

exit 0
