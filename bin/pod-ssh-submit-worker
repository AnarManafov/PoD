#!/usr/bin/env bash
#/************************************************************************/
#/**
# * @file pod-ssh-submit-worker
# * @brief 
# * @author Anar Manafov A.Manafov@gsi.de
# *//*
#
#        created by:        Anar Manafov
#                           2010-06-10
#
#        Copyright (c) 2010 GSI, Scientific Computing group. All rights reserved.
#*************************************************************************/
#
# Usage
# $1 ssh host (login@host.fqdn)
# $2 remote working dir
# $3 a number of PROOF workers to spawn
# $4 ssh params


TOOL_NAME="pod-ssh-submit-worker"
WRK_P="$POD_LOCATION/etc/pod-worker.tar.gz"
WRK_S_R="PoDWorker.sh $3"
WRK_S_L="$POD_LOCATION/etc/PoDWorker.sh"

SSH_CMD="ssh -oBatchMode=yes -n -f -q $1 $4 PasswordAuthentication=no"

# check that the worker package is ready
if [ ! -r $WRK_PKG ]; then
echo "$TOOL_NAME error: can't read a PoD worker package \"$WRK_PKG\""
exit 1
fi

# send a worker package and worker's script
# use rsync since it can automatically create a remote working dir
rsync -aqe ssh $4 $WRK_P $WRK_S_L $1:$2/
if [ $? -ne 0 ]; then
    echo "$TOOL_NAME error: failed to send worker's package"
    exit 1
fi

# execute the worker script
$SSH_CMD "nohup bash -c \"cd $2 && ./$WRK_S_R &> ssh_worker.log \" &> ssh_worker.log  < /dev/null &"
if [ $? -ne 0 ]; then
    echo "$TOOL_NAME error: faild to start PoD worker"
    exit 1
fi

exit 0

